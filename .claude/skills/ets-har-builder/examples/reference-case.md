# 参考案例：CryptoUtils.ets 加密工具类验证

## 概述

本案例验证 ets-har-builder 通用引擎是否能正确识别和声明 `CryptoUtils.ets` 中使用的所有 `@ohos/crypto-js` 库的依赖。

## 验证目标

### 验证前提

1. **禁止返回未知类型**：引擎生成的 DTS 不能返回 `unknown` 或 `known` 等不明确的类型
2. **完整声明所有引用**：源代码中使用的所有字段、类、方法等必须在 DTS 中正确声明
3. **类型明确**：所有返回值必须有明确的类型定义

## 测试源文件

### 文件位置
```
.claude/skills/ets-har-builder/examples/sources/CryptoUtils.ets
```

### 使用的依赖引用

#### 1. 哈希函数
| 源代码 | 引用的方法/常量 | 期望的 DTS 声明 |
|--------|----------------|----------------|
| `CryptoJS.MD5(text)` | `MD5(data: string)` | `const MD5: (data: string) => String;` |
| `CryptoJS.SHA1(text)` | `SHA1(data: string)` | `const SHA1: (data: string) => String;` |
| `CryptoJS.SHA256(text)` | `SHA256(data: string)` | `const SHA256: (data: string) => String;` |

#### 2. 编码器
| 源代码 | 引用的方法/常量 | 期望的 DTS 声明 |
|--------|----------------|----------------|
| `CryptoJS.enc.Utf8.parse(text)` | `enc.Utf8.parse(text: string)` | `const Utf8: { parse(text: string): String; }` |
| `CryptoJS.enc.Utf8.stringify(data)` | `enc.Utf8.stringify(data)` | `const Utf8: { stringify(data: String): string; }` |
| `CryptoJS.enc.Base64.parse(encoded)` | `enc.Base64.parse(encoded)` | `const Base64: { parse(encoded: string): String; }` |
| `CryptoJS.enc.Base64.stringify(data)` | `enc.Base64.stringify(data)` | `const Base64: { stringify(data: String): string; }` |
| `CryptoJS.enc.Hex.parse(hex)` | `enc.Hex.parse(hex)` | `const Hex: { parse(hex: string): String; }` |
| `CryptoJS.enc.Hex.stringify(data)` | `enc.Hex.stringify(data)` | `const Hex: { stringify(data: String): string; }` |
| `CryptoJS.enc.Latin1.stringify(data)` | `enc.Latin1.stringify(data)` | `const Latin1: { stringify(data: String): string; }` |

#### 3. WordArray 类
| 源代码 | 引用的方法/常量 | 期望的 DTS 声明 |
|--------|----------------|----------------|
| `CryptoJS.lib.WordArray.random(16)` | `lib.WordArray.random(nBytes: number)` | `const WordArray: { static random(nBytes: number): WordArray; }` |
| `CryptoJS.lib.WordArray.create([0x00010203, 0x04050607], 4)` | `lib.WordArray.create(words: number[], sigBytes?: number)` | `const WordArray: { static create(words: number[], sigBytes?: number): WordArray; }` |
| `words.toString()` | `toString()` | `interface WordArray { toString(): string; }` |

#### 4. 加密解密
| 源代码 | 引用的方法/常量 | 期望的 DTS 声明 |
|--------|----------------|----------------|
| `CryptoJS.AES.encrypt(text, key)` | `AES.encrypt(data: string, key: string)` | `const AES: { encrypt(data: string, key: string): String; }` |
| `CryptoJS.AES.decrypt(encrypted, key)` | `AES.decrypt(encrypted: string, key: string)` | `const AES: { decrypt(encrypted: string, key: string): String; }` |

#### 5. HMAC
| 源代码 | 引用的方法/常量 | 期望的 DTS 声明 |
|--------|----------------|----------------|
| `CryptoJS.HmacSHA256(text, key)` | `HmacSHA256(data: string, key: string)` | `const HmacSHA256: (data: string, key: string) => String;` |

## 预期生成的 DTS 结构

```typescript
// Auto-generated by ets-har-builder

// 1. 首先定义所有引用的接口类型
interface Md5 {
    (data: string): String;
}

interface Sha1 {
    (data: string): String;
}

interface Sha256 {
    (data: string): String;
}

interface Base64 {
    parse(encoded: string): String;
    stringify(data: String): string;
}

interface Utf8 {
    parse(text: string): String;
    stringify(data: String): string;
}

interface Hex {
    parse(hex: string): String;
    stringify(data: String): string;
}

interface Latin1 {
    stringify(data: String): string;
}

interface WordArray {
    toString(): string;
    static random(nBytes: number): WordArray;
    static create(words: number[], sigBytes?: number): WordArray;
}

interface Aes {
    encrypt(data: string, key: string): String;
    decrypt(encrypted: string, key: string): String;
}

interface HmacSha256 {
    (data: string, key: string): String;
}

// 2. 然后 export 根命名空间
export default CryptoJS;
export { CryptoJS };

// 3. 最后生成 namespace 声明
declare global {
    namespace CryptoJS {
        export const MD5: Md5;
        export const SHA1: Sha1;
        export const SHA256: Sha256;
        export const enc: {
            Base64: Base64;
            Utf8: Utf8;
            Hex: Hex;
            Latin1: Latin1;
        };
        export const lib: {
            WordArray: WordArray;
        };
        export const AES: Aes;
        export const HmacSHA256: HmacSha256;
    }
}
```

## 验证步骤

1. **运行引擎生成依赖**：
```bash
cd D:\code\ets-har-builder\ets-har-builder
mvn clean package -DskipTests
java -jar target/ets-har-builder-1.0-SNAPSHOT.jar "D:\code\example\module"
```

2. **检查生成的 Index.d.ts**：
```bash
cat "D:\code\example\@ohos\crypto-js\Index.d.ts"
```

3. **验证检查点**：

   **✅ 类型明确性**：
   - 没有 `unknown` 或 `known` 类型
   - 所有方法都有明确的参数和返回值类型
   - 所有接口都有完整定义

   **✅ 完整性**：
   - 所有在 `CryptoUtils.ets` 中使用的常量都有声明
   - 所有调用过的方法都有对应的函数声明
   - 所有调用的静态方法都添加到接口定义中

   **✅ 命名空间结构**：
   - 正确的嵌套 namespace 结构
   - 正确的 export 语句
   - 正确的 declare global 结构

4. **编译测试**：
```bash
cd "D:\code\example"
node "C:\Program Files\Huawei\DevEco Studio\tools\hvigor\bin\hvigorw.js" \
  --mode module -p product=default -p module=example@default assembleHar \
  --analyze=normal --parallel --incremental --daemon
```

## 验证清单

### 必须声明的元素

- [ ] CryptoJS.MD5
- [ ] CryptoJS.SHA1
- [ ] CryptoJS.SHA256
- [ ] CryptoJS.enc.Utf8
- [ ] CryptoJS.enc.Base64
- [ ] CryptoJS.enc.Hex
- [ ] CryptoJS.enc.Latin1
- [ ] CryptoJS.lib.WordArray
- [ ] CryptoJS.AES
- [ ] CryptoJS.HmacSHA256

### 必须静态方法的接口
- [ ] WordArray.random(nBytes: number)
- [ ] WordArray.create(words: number[], sigBytes?: number)

### 必须参数类型明确
- [ ] 所有函数参数都有明确类型
- [ ] 所有返回值都有明确类型
- [ ] 不使用 `unknown` 或 `known`

## 失败示例

如果引擎生成以下内容，说明验证失败：

```typescript
// ❌ 不明确的返回类型
function encrypt(data: string): unknown;

// ❌ 接口引用但未定义
function decrypt(data: string): WordArray;  // WordArray 接口未定义

// ❌ 静态方法未识别
const WordArray = { /* 没有 static 方法 */ };

// ❌ 使用 unknown 类型
function parse(data: string): unknown;
```

## 通过示例

```typescript
// ✅ 正确：类型明确且有定义
interface WordArray {
    toString(): string;
    static random(nBytes: number): WordArray;
}

// ✅ 正确：静态方法已添加到接口
const WordArray: {
    static random(nBytes: number): WordArray;
    static create(words: number[], sigBytes?: number): WordArray;
};

// ✅ 正确：所有类型都有定义
function encrypt(data: string, key: string): String;
```